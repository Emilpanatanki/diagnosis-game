<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Guess the Diagnosis...ðŸ¤”</title>
  <style>
    button{transition:transform .12s ease, box-shadow .12s ease;}
    button:hover{transform:translateY(-1px); box-shadow:0 6px 16px rgba(10,20,60,.08);}
    :root{
      --bg:#f7faff; --panel:#ffffff; --ink:#0b1220; --muted:#4b5565;
      --green:#15a377; --amber:#eab308; --orange:#b7791f; --red:#d64545; --accent:#2563eb;
      --chip:#f3f6fb; --chip-b:#e5eaf3; --border:#e6e9f2;
    }
    html,body{
      background:var(--bg);
      color:var(--ink);
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      margin:0;
    }
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px}
    h1{font-size:24px; margin:0 0 12px}
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      box-shadow:0 6px 18px rgba(10,20,60,.05);
    }
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row > *{flex:1 1 0}

    input[type="text"]{
      width:100%;
      max-width:320px;
      background:#ffffff;
      color:#0b1220;
      border:1px solid #dce1eb;
      border-radius:10px;
      padding:10px 12px;
      font-size:16px;        /* prevents iOS zoom-on-focus */
    }
    button{
      background:var(--accent);
      color:#ffffff;
      border:0;
      border-radius:12px;
      padding:10px 16px;
      font-weight:600;
      cursor:pointer;
      white-space:nowrap;
    }
    button:disabled{opacity:.5; cursor:not-allowed}

    .chips{display:flex; flex-wrap:wrap; gap:6px}
    .chip{
      background:var(--chip);
      border:1px solid var(--chip-b);
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      display:inline-block;
      margin:4px 4px 4px 0;
    }
    .chip.green{ background:rgba(21,163,119,.14); border-color:rgba(21,163,119,.35); }
    .chip.amber{ background:rgba(234,179,8,.18); border-color:rgba(234,179,8,.45); }
    .chip.orange{ background:rgba(183,121,31,.16); border-color:rgba(183,121,31,.42); }
    .chip.red{ background:rgba(214,69,69,.16); border-color:rgba(214,69,69,.42); }

    table{width:100%; border-collapse:separate; border-spacing:0; margin-top:8px}
    thead th{position:sticky; top:0; background:#f4f7ff; z-index:2}
    th, td{
      border-bottom:1px solid var(--border);
      padding:8px;
      text-align:left;
      vertical-align:top;
      font-size:13px;
    }
    tbody tr:hover{background:#f9fbff}

    .legend{
      display:flex;
      gap:12px;
      align-items:center;
      color:var(--muted);
      font-size:13px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .swatch{
      width:14px;
      height:14px;
      border-radius:4px;
      display:inline-block;
      margin-right:6px;
    }
    .swatch.g{background:var(--green)}
    .swatch.y{background:var(--amber)}
    .swatch.o{background:var(--orange)}
    .swatch.r{background:var(--red)}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .colwrap{overflow:auto; margin-top:8px;}

    /* (2) Progress bar: fatter + better spacing */
    .progress-bar{
      margin-top:12px;
      margin-bottom:8px;
      width:100%;
      max-width:100%;
      height:14px;
      border-radius:999px;
      background:#e5eaf3;
      overflow:hidden;
    }
    .progress-inner{
      height:100%;
      width:0;
      border-radius:999px;
      background:var(--accent);
      transition:width .2s ease;
    }

    /* Status banner */
    #statusMsg{
      margin-top:8px;
      padding:6px 10px;
      border-radius:10px;
      background:#eef2ff;
      color:#111827;
      font-size:12px;
      display:none;
    }
    #statusMsg.status-visible{
      display:block;
    }

    /* Guess cards for mobile view */
    .cards{
      display:none;
      margin-top:8px;
    }
    .guess-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:#ffffff;
      box-shadow:0 4px 12px rgba(15,23,42,0.06);
      margin-top:8px;
      transition:border-color .15s ease, background-color .15s ease;
    }
    /* (4) highlight latest guess */
    .guess-card.latest-card{
      background:#f7f9ff;
      border-color:#cbd5ff;
    }
    .guess-card-header{
      font-weight:600;
      margin-bottom:4px;
    }
    .guess-card-row{
      display:flex;
      gap:6px;
      align-items:flex-start;
      margin-bottom:4px;
    }
    .guess-card-label{
      font-size:11px;
      font-weight:600;
      color:var(--muted);
      min-width:90px;
      flex:0 0 auto;
    }
    .guess-card-value{
      flex:1 1 auto;
    }

    /* Show cards instead of table on narrow screens (no extra tightening) */
    @media (max-width: 768px){
      .colwrap{ display:none; }
      .cards{ display:block; }
    }

    /* Solved modal */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .overlay.is-open{ display:flex; }
    .modal{
      background:#ffffff;
      padding:20px 24px;
      border-radius:18px;
      max-width:340px;
      width:90%;
      text-align:center;
      box-shadow:0 18px 40px rgba(15,23,42,0.25);
    }
    .modal h2{
      margin:0 0 8px;
      font-size:18px;
    }
    .modal p{
      margin:4px 0;
      font-size:14px;
      color:var(--muted);
    }
    .modal button{
      margin-top:10px;
      width:100%;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Guess the Diagnosis...ðŸ¤”</h1>

    <!-- Vignette card -->
    <div id="vignetteCard" class="card" style="margin-top:16px">
      <p id="vignetteText" style="margin:0"></p>
    </div>

    <div class="card" style="margin-top:16px">
      <!-- Input + Add button on the same row -->
      <div class="row" style="align-items:flex-end;">
        <div style="flex:1 1 auto;">
          <input id="guess" list="diagnosisList" type="text" placeholder="Start typing a diagnosisâ€¦" />
          <datalist id="diagnosisList"></datalist>
        </div>
        <div style="flex:0 0 auto;">
          <button id="guessBtn">Add</button>
        </div>
      </div>

      <div id="statusMsg" class="small muted"></div>

      <div class="progress-bar" role="progressbar" aria-label="Best similarity so far" aria-valuemin="0" aria-valuemax="100">
        <div id="progressInner" class="progress-inner" aria-valuenow="0"></div>
      </div>

      <div class="legend">
        <span><span class="swatch g"></span>Green = exact/very close</span>
        <span><span class="swatch y"></span>Yellow = close near-miss</span>
        <span><span class="swatch o"></span>Orange = partial overlap</span>
        <span><span class="swatch r"></span>Red = different</span>
      </div>

      <!-- Desktop: table view -->
      <div class="colwrap">
        <table id="table">
          <thead>
            <tr>
              <th>Guess</th>
              <th>System</th>
              <th>Age group</th>
              <th>Epidemiology</th>
              <th>Etiology</th>
              <th>Key findings</th>
              <th>Management</th>
              <th>Course</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Mobile: card view -->
      <div id="cardsContainer" class="cards"></div>
    </div>

    <p class="small muted" style="margin-top:10px">Educational use only. Not medical advice.</p>
  </div>

  <!-- Solved popup -->
  <div id="solvedOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="solvedTitle">
    <div class="modal">
      <h2 id="solvedTitle">ðŸŽ‰ Correct!</h2>
      <p id="solvedText"></p>
      <p id="solvedDx" class="small"></p>
      <button id="shareBtn">Share</button>
      <button id="closeSolvedBtn">Close</button>
    </div>
  </div>

  <script>
  (function(){
    const CSV_30 = `Diagnosis,Aliases,System,AgeGroup,Epidemiology,Etiology,Onset,KeyFindings,Investigation,Management,SeverityRisk
Myocardial Infarction,Heart attack; MI,cardiovascular,older adult (65+),male; smoker; atherosclerosis; DM,vascular; thrombotic,acute,chest pain; dyspnea; diaphoresis,ecg; troponin,antiplatelets; anticoagulation; reperfusion,high
Pneumonia,Lower respiratory tract infection,respiratory,older adult (65+),winter; aspiration; nursing home,infection,acute,fever; cough; dyspnea; sputum,cxr,antibiotics; supportive,moderate
Asthma,Bronchial asthma,respiratory,child,atopy; FHx,inflammatory,acute; recurrent; episodic,wheeze; cough; dyspnea,spirometry,bronchodilators; steroids,low
Stroke,Cerebrovascular accident; CVA,neurology,older adult (65+),HTN; AF,vascular; thrombotic,acute,weakness focal; facial droop; confusion,ct; mri,reperfusion; antiplatelets; anticoagulation,high
Appendicitis,,gastrointestinal,young adult,appendiceal obstruction,obstructive; infection,acute,RLQ pain; fever; nausea vomiting,clinical; ultrasound,appendectomy,moderate
Diabetic Ketoacidosis,DKA,endocrine,adolescent,T1DM; insulin omission; infection,metabolic,acute,polyuria; polydipsia; dehydration; nausea vomiting,blood glucose; ketones; abg,iv fluids; insulin; electrolytes,high
Cholelithiasis,Gallstones,gastrointestinal,middle adult,female; obesity; fatty meals; pregnancy,obstructive,variable,RUQ pain; nausea,ultrasound,analgesia; cholecystectomy,low
Tuberculosis,TB,respiratory,young adult,close contact; high-prevalence area,infection,chronic,cough; weight loss; night sweats; fever,sputum smear; cxr,anti-TB therapy,moderate
Hypertension,High blood pressure,cardiovascular,middle adult,FHx; obesity; high salt,genetic; idiopathic,chronic,headache; often asymptomatic,BP measurement,lifestyle; antihypertensives,moderate
Chronic Obstructive Pulmonary Disease,COPD,respiratory,older adult (65+),smoker; occupational exposure,inflammatory; obstructive,chronic,dyspnea; cough; sputum,spirometry,bronchodilators; steroids; smoking cessation,moderate
Gastroesophageal Reflux Disease,GERD,gastrointestinal,middle adult,obesity; late meals; hiatal hernia,functional,chronic,heartburn; regurgitation; chest pain,pH monitoring; endoscopy,PPI; lifestyle,low
Migraine,,neurology,young adult,female; FHx,idiopathic,recurrent; episodic,headache; photophobia; nausea vomiting,clinical,analgesics; prophylaxis,low
Depression,Major depressive disorder,psychiatry,young adult,prior episode; psychosocial stressors,idiopathic; genetic,chronic; episodic,low mood; anhedonia; fatigue,clinical,antidepressants; psychotherapy,moderate
Anxiety Disorder,Generalized anxiety disorder,psychiatry,young adult,chronic worry; stress,idiopathic,chronic,restlessness; insomnia; fatigue,clinical,anxiolytics; psychotherapy,low
Bipolar Disorder,Manic depression,psychiatry,young adult,FHx mood disorder,idiopathic; genetic,episodic,mood swings; â†“ sleep need,clinical,mood stabilizers; antipsychotics,moderate
Peptic Ulcer Disease,PUD,gastrointestinal,middle adult,NSAIDs; H. pylori,infection,chronic; recurrent,epigastric pain; nausea,endoscopy,PPI; H. pylori eradication,low
Viral Hepatitis B,Hep B,gastrointestinal,young adult,unvaccinated; blood exposure; sexual exposure,infection,acute; chronic,jaundice; fatigue; nausea,HbsAg; LFTs,antivirals; supportive,moderate
Viral Hepatitis C,Hep C,gastrointestinal,middle adult,IVDU; past transfusion,infection,chronic,fatigue; often asymptomatic,HCV Ab; HCV RNA,antivirals,moderate
HIV/AIDS,Human immunodeficiency virus infection,immunology,young adult,unprotected sex; IVDU,infection,chronic,weight loss; fever; opportunistic infections,HIV Ab/Ag; HIV RNA,ART; prophylaxis,high
Sepsis,Septicemia,immunology,older adult (65+),hospitalized; invasive devices,infection,acute,fever; hypotension; tachycardia,blood cultures; lactate,iv antibiotics; iv fluids; vasopressors,high
Urinary Tract Infection,UTI,genitourinary,young adult,sexually active F; prior UTI,infection,acute,dysuria; frequency; suprapubic pain,urinalysis; urine culture,oral antibiotics; analgesia,low
Pyelonephritis,,genitourinary,young adult,F; ascending UTI,infection,acute,fever; flank pain; nausea vomiting,urinalysis; urine culture,iv antibiotics; fluids,moderate
Nephrolithiasis,Kidney stones,genitourinary,young adult,dehydration; prior stones,metabolic; obstructive,acute; recurrent,flank pain; hematuria,ct,analgesia; hydration; removal,moderate
Chronic Kidney Disease,CKD,genitourinary,older adult (65+),long-standing DM; long-standing HTN,metabolic,chronic,fatigue; edema; pruritus,eGFR; creatinine; urine ACR,BP control; dialysis; nephroprotective,high
Otitis Media,,ent,infant,daycare; recent URTI,infection,acute,ear pain; fever; irritability,otoscopy,analgesia; antibiotics,low
Otitis Externa,Swimmer's ear,ent,adolescent,swimmer; local trauma,infection,acute,ear pain; discharge,otoscopy,topical antibiotics; ear drops,low
Sinusitis,Rhinosinusitis,ent,young adult,post-upper RTI; allergic rhinitis,infection,acute,facial pain; nasal congestion; headache,clinical,steroids; decongestants; antibiotics,low
Tonsillitis,Pharyngitis,ent,adolescent,winter; close contact,infection,acute,sore throat; fever; dysphagia,throat swab,analgesia; antibiotics,low
Conjunctivitis,Pink eye,ophthalmology,young adult,contact; viral; bacterial,infection,acute,red eye; discharge,clinical,topical antibiotics; supportive,low
Glaucoma,,ophthalmology,older adult (65+),â†‘ IOP; FHx,degenerative,chronic,peripheral vision loss; headache,tonometry,drops; surgery,moderate
Cataract,,ophthalmology,older adult (65+),lens degeneration,degenerative,chronic,blurred vision; glare,slit-lamp exam,surgery,low
Retinal Detachment,,ophthalmology,middle adult,myopia; eye trauma; prior surgery,degenerative,acute,flashes; floaters; shadow in vision,fundoscopy,surgery,high
Epilepsy,Seizure disorder,neurology,young adult,idiopathic; prior brain injury,idiopathic,chronic; recurrent,seizure; postictal confusion,EEG,antiepileptics,moderate
Multiple Sclerosis,MS,neurology,young adult,F; temperate climate,autoimmune,chronic,vision blur; focal weakness; numbness,MRI; CSF,steroids; immunotherapy,moderate
Parkinson's Disease,,neurology,older adult (65+),male; idiopathic,degenerative,chronic,tremor; rigidity; bradykinesia,clinical,dopaminergic; supportive,moderate
Alzheimer's Disease,,neurology,older adult (65+),degenerative; FHx,degenerative,chronic,memory loss; confusion,clinical; neuropsych,cognitive drugs; supportive,high
Meningitis,,neurology,child,unvaccinated; close living,infection,acute,fever; neck stiffness; headache,LP,iv antibiotics; supportive,high
Encephalitis,,neurology,young adult,viral; seasonal exposure,infection; inflammatory,acute,fever; confusion; seizure,MRI; CSF,antivirals; supportive,high
Herpes Zoster,Shingles,dermatology,older adult (65+),reactivation VZV,infection,acute,vesicular rash; dermatomal pain,clinical,antivirals; analgesia,mixed
Cellulitis,,dermatology,middle adult,skin break; chronic edema,infection,acute,fever; erythema; warmth,clinical,antibiotics; elevation,low
Psoriasis,,dermatology,young adult,FHx,inflammatory,chronic,scaly plaques; pruritus,clinical,steroids; immunomodulators,low
Eczema,Atopic dermatitis,dermatology,infant,atopy; FHx,inflammatory,chronic,pruritus; dry patches,clinical,emollients; steroids,low
Acne Vulgaris,Acne,dermatology,adolescent,puberty; â†‘ sebum,inflammatory,chronic; recurrent,papules; pustules; comedones,clinical,retinoids; antibiotics; hygiene,low
Melanoma,,dermatology,middle adult,fair skin; intense sun,neoplastic,chronic,irregular lesion; color change,biopsy,excision; oncology,high
Basal Cell Carcinoma,BCC,dermatology,older adult (65+),chronic sun,neoplastic,chronic,pearly papule; ulcer,biopsy,excision; local therapy,low
Squamous Cell Carcinoma,SCC,dermatology,older adult (65+),sun; immunosuppression,neoplastic,chronic,ulcerated nodule; scale,biopsy,excision; radiotherapy,moderate
Rheumatoid Arthritis,RA,rheumatology,middle adult,F; autoimmune,autoimmune,chronic,arthralgia; joint swelling; morning stiffness,RF; anti-CCP; ESR/CRP,DMARDs; NSAIDs; steroids,moderate
Osteoarthritis,,rheumatology,older adult (65+),wear-and-tear; obesity,degenerative,chronic,arthralgia; worse with use; brief stiffness,x-ray,analgesia; physio; replacement,low
Gout,,rheumatology,middle adult,M; hyperuricemia; alcohol,metabolic,acute; recurrent,joint swelling; severe pain (1st MTP),uric acid; joint aspiration,NSAIDs; colchicine; urate-lowering,low
Systemic Lupus Erythematosus,SLE,rheumatology,young adult,F; autoimmune; multisystem,autoimmune,chronic,malar rash; arthralgia; fatigue,ANA; anti-dsDNA,immunosuppressants; steroids,mixed
Anemia (Iron Deficiency),,hematology,young adult,menorrhagia; low iron intake; chronic blood loss,deficiency,chronic,fatigue; pallor; dyspnea on exertion,CBC; ferritin,iron; treat cause,low
Angina Pectoris,Stable angina,cardiovascular,older adult (65+),male; smoker; atherosclerosis,vascular; ischemic,exertional; recurrent,chest discomfort; exertional dyspnea; relief with rest,ecg; stress test; troponin,nitrates; beta-blockers; risk factor control,moderate
Acute Bronchitis,,respiratory,older adult (65+),post-viral; smoker,infection,acute,cough; sputum; mild fever,clinical,supportive; bronchodilators,low
Panic Attack,Panic episode,psychiatry,adolescent,stress; anxiety disorder,idiopathic,acute; episodic,dyspnea; palpitations; chest tightness; fear,clinical; exclude organic,reassurance; anxiolytics; psychotherapy,low
Transient Ischemic Attack,TIA,neurology,older adult (65+),HTN; AF; atherosclerosis,vascular; thrombotic,acute; transient,focal weakness; speech difficulty; resolved symptoms,ct; mri; carotid doppler,antiplatelets; risk factor control,moderate
Gastroenteritis,,gastrointestinal,young adult,foodborne; contacts,infection,acute,abdominal cramps; diarrhea; vomiting,stool tests (if severe),oral fluids; antiemetics,low
Severe Dehydration,,general medicine,adolescent,prolonged vomiting; diarrhea,metabolic,acute,thirst; dizziness; reduced urine,blood tests; vitals,iv fluids; treat cause,high
Acute Cholecystitis,,gastrointestinal,middle adult,female; gallstones,obstructive; infection,acute,RUQ pain; fever; Murphy sign,ultrasound,iv antibiotics; cholecystectomy,moderate
Chronic Bronchitis,,respiratory,older adult (65+),smoker; occupational exposure,inflammatory; obstructive,chronic,cough; sputum; dyspnea,spirometry; cxr,bronchodilators; smoking cessation,moderate
White-coat Hypertension,,cardiovascular,middle adult,clinic anxiety,physiologic,chronic,elevated BP in clinic; normal at home,BP monitoring; ambulatory BP,reassurance; lifestyle,low
Heart Failure,CHF; congestive heart failure,cardiovascular,older adult (65+),ischemic heart disease; HTN,cardiac; pump failure,chronic,dyspnea on exertion; orthopnea; edema,echocardiogram; BNP,diuretics; ACEi/ARB; beta-blockers,high
Costochondritis,,musculoskeletal,middle adult,physical strain; coughing,mechanical,acute,localized chest wall pain; tenderness on palpation,clinical,analgesia; rest,low
Tension Headache,,neurology,young adult,stress; poor posture,idiopathic,recurrent; episodic,band-like headache; no focal signs,clinical,analgesia; stress management,low
Hypothyroidism,,endocrine,young adult,F; autoimmune (Hashimoto),hormonal,chronic,fatigue; weight gain; cold intolerance,TSH; T4,thyroxine replacement,low
Hyperthyroidism,,endocrine,young adult,F; Graves,autoimmune,chronic,anxiety; tremor; weight loss,TSH; T4; T3,antithyroid drugs; beta-blockers,moderate
Cyclothymic Disorder,,psychiatry,young adult,FHx mood disorder,idiopathic; genetic,chronic,mood fluctuations; periods of elevated and low mood,clinical,mood stabilizers; psychotherapy,low
Functional Dyspepsia,Non-ulcer dyspepsia,gastrointestinal,middle adult,stress; idiopathic,functional,chronic,epigastric discomfort; early satiety,endoscopy (to exclude),PPI; diet modification; reassurance,low
Autoimmune Hepatitis,,gastrointestinal,young adult,F; autoimmune,autoimmune,chronic,fatigue; jaundice; arthralgia,LFTs; autoantibodies; biopsy,steroids; immunosuppressants,moderate
Nonalcoholic Fatty Liver Disease,NAFLD,gastrointestinal,middle adult,obesity; DM; dyslipidemia,metabolic,chronic,fatigue; often asymptomatic,LFTs; ultrasound,lifestyle; weight loss,low
Chronic Infection,,immunology,young adult,immunosuppressed; low SES,infection,chronic,weight loss; low-grade fever; malaise,blood tests; cultures,treat source infection,moderate
Influenza,Flu,respiratory,older adult (65+),winter; unvaccinated,infection,acute,fever; myalgia; cough,clinical; PCR (if needed),antivirals; supportive,moderate
Vaginitis,,genitourinary,young adult,sexually active; antibiotics use,infection,acute,vaginal discharge; pruritus; dysuria,swabs; microscopy,antifungals; antibiotics; hygiene,low
Renal Abscess,Perinephric abscess,genitourinary,young adult,untreated pyelonephritis,infection,acute; subacute,flank pain; fever; malaise,ct; ultrasound,iv antibiotics; drainage,high
Musculoskeletal Back Pain,Mechanical low back pain,musculoskeletal,young adult,heavy lifting; poor posture,mechanical,acute; recurrent,localized back pain; worse with movement,clinical; x-ray (if red flags),analgesia; physio,low
Teething Otalgia,,ent,infant,teething,physiologic,acute,ear pulling; irritability; drooling,clinical,reassurance; analgesia,low
Allergic Otitis Externa,,ent,adolescent,allergic skin disease,inflammatory,acute,ear itching; mild pain; no fever,otoscopy,topical steroids; avoidance,low
Allergic Rhinitis,Hay fever,ent,young adult,atopy; pollen exposure,allergic,chronic;sneezing; nasal congestion; itchy eyes,clinical,antihistamines; nasal steroids,low
Pharyngitis,,ent,adolescent,winter; close contact,infection,acute,sore throat; odynophagia; low-grade fever,throat swab (if needed),analgesia; antibiotics (if bacterial),low
Allergic Conjunctivitis,,ophthalmology,young adult,atopy; seasonal allergens,allergic,acute,red itchy eye; watery discharge,clinical,antihistamine drops; avoidance,low
Macular Degeneration,Age-related macular degeneration; AMD,ophthalmology,older adult (65+),age; smoking; FHx,degenerative,chronic,central vision loss; distortion,fundoscopy; OCT,anti-VEGF; lifestyle,moderate
Presbyopia,,ophthalmology,older adult (65+),age-related,degenerative,chronic,difficulty with near vision,clinical,corrective lenses,low
Vitreous Detachment,Posterior vitreous detachment,ophthalmology,older adult (65+),age; myopia,degenerative,acute,floaters; flashes; no field defect,fundoscopy,observation; treat complications,low
Syncope,Fainting,cardiovascular,young adult,dehydration; vasovagal; arrhythmia,cardiovascular; autonomic,acute,transient loss of consciousness; spontaneous recovery,ecg; orthostatic vitals,fluids; treat underlying cause,moderate
Neuromyelitis Optica,NMO spectrum disorder,neurology,young adult,F; autoimmune,autoimmune,chronic; relapsing,optic neuritis; myelitis; visual loss,MRI; aquaporin-4 Ab,immunotherapy; steroids,high
Essential Tremor,,neurology,older adult (65+),FHx; idiopathic,idiopathic,chronic,action tremor; improved with alcohol,clinical,beta-blockers; primidone,low
Mild Cognitive Impairment,MCI,neurology,older adult (65+),age; FHx,degenerative,chronic,memory complaints; preserved function,neuropsych testing,monitoring; risk factor control,moderate
Viral Syndrome,,general medicine,child,household contacts,infection,acute,fever; malaise; headache,clinical,supportive,low
Toxic-metabolic Encephalopathy,,neurology,young adult,organ failure; drugs; sepsis,metabolic; toxic,acute,confusion; altered consciousness; asterixis,blood tests; imaging,treat underlying; supportive,high
Contact Dermatitis,,dermatology,middle adult,irritants; allergens,inflammatory,acute,localized erythema; pruritus,clinical,avoid trigger; topical steroids,low
Erysipelas,,dermatology,older adult (65+),skin break; lymphatic compromise,infection,acute,well-demarcated erythema; fever,clinical,antibiotics,moderate
Seborrheic Dermatitis,,dermatology,young adult,sebaceous areas; FHx,inflammatory,chronic,greasy scales; erythema (scalp; face),clinical,antifungal shampoo; topical steroids,low
Xerosis (Dry Skin),,dermatology,infant,cold weather; low humidity,physiologic,chronic,dry rough skin; pruritus,clinical,emollients; avoid irritants,low
Folliculitis,,dermatology,adolescent,shaving; occlusion,infection,acute,small pustules; perifollicular papules,clinical,topical antiseptics; antibiotics,low
Dysplastic Nevus,Atypical mole,dermatology,middle adult,fair skin; sun exposure,neoplastic potential,chronic,irregular pigmented lesion,dermatoscopic exam; biopsy,excision; surveillance,moderate
Actinic Keratosis,,dermatology,older adult (65+),chronic sun exposure,neoplastic potential,chronic,rough scaly patch; sun-exposed skin,clinical; biopsy (if atypical),cryotherapy; topical agents,low
Keratoacanthoma,,dermatology,older adult (65+),sun exposure; smoking,neoplastic,chronic,rapidly growing crateriform nodule,biopsy,excision,moderate
Polymyalgia Rheumatica,PMR,rheumatology,older adult (65+),F; Northern European; associated with GCA,autoimmune; inflammatory,chronic,morning stiffness; shoulder/hip pain,ESR; CRP,low-dose steroids,moderate
Bursitis,,rheumatology,middle adult,overuse; trauma,mechanical,acute; subacute,localized joint pain; tenderness; swelling,clinical; ultrasound (if needed),rest; NSAIDs; aspiration (if needed),low
Pseudogout,Calcium pyrophosphate deposition disease,rheumatology,older adult (65+),age; joint disease,metabolic,acute; recurrent,acute joint pain; swelling; knee often involved,joint aspiration; x-ray,NSAIDs; colchicine,low
Fibromyalgia,,rheumatology,young adult,F; psychosocial stressors,central sensitization,chronic,widespread pain; fatigue; poor sleep,clinical,exercise; CBT; analgesia,low
Anemia of Chronic Disease,ACD,hematology,older adult (65+),chronic infection; autoimmune disease,deficiency; inflammatory,chronic,fatigue; pallor; dyspnea on exertion,CBC; iron studies,treat underlying; Â± iron,moderate`;}


    const VIGNETTES = {
      'myocardial infarction': 'A 60 year old male presents with chest pain.',
    'pneumonia': 'A 72 year old female presents with fever and cough.',
    'asthma': 'A 16 year old male presents with shortness of breath.',
    'stroke': 'A 71 year old female presents with sudden weakness on one side.',
    'appendicitis': 'A 21 year old male presents with stomach pain.',
    'diabetic ketoacidosis': 'A 19 year old female presents feeling very unwell.',
    'cholelithiasis': 'A 42 year old female presents with upper stomach pain.',
    'tuberculosis': 'A 28 year old female presents with a long-lasting cough.',
    'hypertension': 'A 55 year old female presents with high blood pressure.',
    'chronic obstructive pulmonary disease': 'A 67 year old male presents with breathlessness on exertion.',
    'gastroesophageal reflux disease': 'A 35 year old male presents with burning chest pain after meals.',
    'migraine': 'A 25 year old male presents with recurring headaches.',
    'depression': 'A 31 year old female presents with low mood.',
    'anxiety disorder': 'A 23 year old male presents feeling constantly anxious.',
    'bipolar disorder': 'A 26 year old male presents with changes in mood.',
    'peptic ulcer disease': 'A 48 year old female presents with upper stomach pain.',
    'viral hepatitis b': 'A 32 year old male presents with tiredness.',
    'viral hepatitis c': 'A 58 year old female presents with ongoing fatigue.',
    'hiv/aids': 'A 33 year old male presents with weight loss.',
    'sepsis': 'An 80 year old female presents feeling acutely unwell with fever.',
    'urinary tract infection': 'A 26 year old female presents with painful urination.',
    'pyelonephritis': 'A 40 year old female presents with pain in the side and fever.',
    'nephrolithiasis': 'A 34 year old female presents with severe lower back pain.',
    'chronic kidney disease': 'A 70 year old male presents with tiredness and swollen ankles.',
    'otitis media': 'A 3 year old male presents with ear pain and fever.',
    'otitis externa': 'A 14 year old female presents with ear pain.',
    'sinusitis': 'A 30 year old female presents with a blocked nose.',
    'tonsillitis': 'A 17 year old female presents with a sore throat.',
    'conjunctivitis': 'A 22 year old female presents with a red eye.',
    'glaucoma': 'A 68 year old male presents with gradual changes in vision.',
    'cataract': 'A 74 year old female presents with slowly worsening vision.',
    'retinal detachment': 'A 56 year old male presents with a new shadow in his vision.',
    'epilepsy': 'A 20 year old female presents with repeated episodes of lost awareness.',
    'multiple sclerosis': 'A 27 year old female presents with intermittent weakness.',
    "parkinson's disease": 'A 73 year old male presents with a shaking hand.',
    "alzheimer's disease": 'A 79 year old female presents with memory problems.',
    'meningitis': 'A 6 year old male presents with fever and headache.',
    'encephalitis': 'A 19 year old female presents with fever and confusion.',
    'herpes zoster': 'A 64 year old female presents with a painful skin area.',
    'cellulitis': 'A 52 year old male presents with a red, warm area on the leg.',
    'psoriasis': 'A 30 year old male presents with scaly skin patches.',
    'eczema': 'A 5 year old female presents with itchy dry skin.',
    'acne vulgaris': 'A 16 year old female presents with spots on the face.',
    'melanoma': 'A 45 year old male presents with a changing mole.',
    'basal cell carcinoma': 'A 62 year old female presents with a small skin bump.',
    'squamous cell carcinoma': 'A 70 year old male presents with a rough skin patch.',
    'rheumatoid arthritis': 'A 38 year old female presents with painful hands in the morning.',
    'osteoarthritis': 'A 68 year old female presents with painful knees when walking.',
    'gout': 'A 47 year old male presents with sudden pain in the big toe.',
    'systemic lupus erythematosus': 'A 29 year old female presents with joint pain and tiredness.',
    'anemia (iron deficiency)': 'A 24 year old female presents with feeling very tired.',
    'angina pectoris': 'A 62 year old male presents with chest discomfort.',
    'acute bronchitis': 'A 68 year old female presents with cough and malaise.',
    'panic attack': 'A 17 year old female presents with sudden difficulty breathing.',
    'transient ischemic attack': 'A 70 year old male presents with brief weakness on one side.',
    'gastroenteritis': 'A 22 year old male presents with stomach discomfort.',
    'severe dehydration': 'A 20 year old female presents feeling extremely unwell.',
    'acute cholecystitis': 'A 44 year old female presents with upper abdominal discomfort.',
    'chronic bronchitis': 'A 30 year old female presents with a long-standing cough.',
    'white-coat hypertension': 'A 57 year old female presents with elevated blood pressure at a clinic visit.',
    'heart failure': 'A 69 year old male presents with breathlessness when active.',
    'costochondritis': 'A 34 year old male presents with chest discomfort after activity.',
    'tension headache': 'A 26 year old male presents with recurrent head pain.',
    'hypothyroidism': 'A 33 year old female presents with persistent low energy.',
    'hyperthyroidism': 'A 25 year old male presents feeling constantly on edge.',
    'cyclothymic disorder': 'A 27 year old male presents with fluctuating mood patterns.',
    'functional dyspepsia': 'A 49 year old female presents with upper stomach discomfort.',
    'autoimmune hepatitis': 'A 33 year old male presents with unexplained tiredness.',
    'nonalcoholic fatty liver disease': 'A 59 year old female presents with ongoing fatigue.',
    'chronic infection': 'A 34 year old male presents with unintentional weight loss.',
    'influenza': 'An 81 year old female presents feeling suddenly unwell with fever.',
    'vaginitis': 'A 27 year old female presents with discomfort on urination.',
    'renal abscess': 'A 41 year old female presents with flank pain and fever.',
    'musculoskeletal back pain': 'A 35 year old female presents with severe lower back pain.',
    'teething otalgia': 'A 3 year old male presents with ear discomfort and irritability.',
    'allergic otitis externa': 'A 14 year old female presents with ear itching and pain.',
    'allergic rhinitis': 'A 31 year old female presents with nasal blockage.',
    'pharyngitis': 'A 17 year old female presents with a painful throat.',
    'allergic conjunctivitis': 'A 22 year old female presents with a red itchy eye.',
    'macular degeneration': 'A 68 year old male presents with gradual changes in central vision.',
    'presbyopia': 'A 74 year old female presents with slowly worsening near vision.',
    'vitreous detachment': 'A 56 year old male presents with new floaters and flashes.',
    'syncope': 'A 20 year old female presents with brief episodes of lost awareness.',
    'neuromyelitis optica': 'A 27 year old female presents with intermittent visual loss and weakness.',
    'essential tremor': 'A 73 year old male presents with a shaking hand when reaching for objects.',
    'mild cognitive impairment': 'A 79 year old female presents with memory concerns.',
    'viral syndrome': 'A 6 year old male presents with fever and feeling generally unwell.',
    'toxic-metabolic encephalopathy': 'A 19 year old female presents with confusion and fever.',
    'contact dermatitis': 'A 64 year old female presents with a painful itchy skin area.',
    'erysipelas': 'A 52 year old male presents with a warm, sharply red area on the leg.',
    'seborrheic dermatitis': 'A 30 year old male presents with scaly skin patches on the scalp.',
    'xerosis (dry skin)': 'A 5 year old female presents with dry, itchy skin.',
    'folliculitis': 'A 16 year old female presents with small red spots on the face.',
    'dysplastic nevus': 'A 45 year old male presents with a changing skin mark.',
    'actinic keratosis': 'A 62 year old female presents with a small rough skin spot.',
    'keratoacanthoma': 'A 70 year old male presents with a rapidly growing skin bump.',
    'polymyalgia rheumatica': 'A 68 year old female presents with painful shoulders in the morning.',
    'bursitis': 'A 68 year old female presents with painful knees when moving.',
    'pseudogout': 'A 47 year old male presents with sudden knee pain.',
    'fibromyalgia': 'A 29 year old female presents with widespread pain and tiredness.',
    'anemia of chronic disease': 'A 70 year old female presents with feeling very tired.'
    };

    const RELATEDNESS={
      system:{ 'ent':{'respiratory':0.6} },
      etiology:{ 'infection':{'inflammatory':0.5,'autoimmune':0.25}, 'autoimmune':{'inflammatory':0.6}, 'vascular':{'thrombotic':0.7}, 'unknown':{} },
      management:{ 'medication':{'mixed':0.7,'supportive':0.4}, 'surgery':{'mixed':0.6}, 'antivirals':{'medication':0.5} },
      course:{ 'acute':{'subacute':0.6,'episodic':0.5}, 'chronic':{'recurrent':0.55,'variable':0.4} },
      age:{}
    };

    const AGE_ORDER = [
      'neonate (0-28d)',
      'infant',
      'toddler',
      'child',
      'adolescent',
      'young adult',
      'middle adult',
      'older adult (65+)'
    ];
    const AGE_ALIASES = {
      'children':['child'],
      'young adults':['young adult'],
      'adults':['young adult','middle adult','older adult (65+)'],
      'elderly':['older adult (65+)'],
      'adults/elderly':['middle adult','older adult (65+)'],
      'children/young adults':['child','adolescent','young adult']
    };
    const AGE_INDEX = new Map(AGE_ORDER.map((v,i)=>[v,i]));

    const AGE_DISPLAY = {
      'infant': 'infant (0â€“1y)',
      'toddler': 'toddler (1â€“3y)',
      'child': 'child (4â€“11y)',
      'adolescent': 'adolescent (12â€“18y)',
      'young adult': 'young adult (18â€“40y)',
      'middle adult': 'middle adult (40â€“65y)',
      'older adult (65+)': 'older adult (65+)',
      'neonate (0-28d)': 'neonate (0â€“28d)'
    };

    const WEIGHTS = {
      system: 1.5,
      age: 1.2,
      epi: 1.2,
      etiology: 1.0,
      findings: 1.5,
      management: 0.9,
      course: 0.7
    };
    const TOTAL_WEIGHT =
      WEIGHTS.system + WEIGHTS.age + WEIGHTS.epi +
      WEIGHTS.etiology + WEIGHTS.findings +
      WEIGHTS.management + WEIGHTS.course;

    let DATA=[];
    let BY_NAME=new Map();
    let TARGET=null;
    let GUESSED=new Set();
    let bestScoreSoFar=0;
    let guessesToday=0;
    let solvedToday=false;

    function normalizeToken(s){ return (s||'').toString().trim().toLowerCase(); }

    function splitTags(s){
      if(!s) return [];
      const normalized = s.replace(/[,/|]/g,';').replace(/\s*;\s*/g,';').toLowerCase();
      return normalized.split(';').map(t=>t.trim()).filter(Boolean);
    }

    function parseCSV(text){
      const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length>0);
      if(lines.length===0) return [];
      function parseLine(line){
        const cells=[]; let cur=''; let inQ=false;
        for(let i=0;i<line.length;i++){
          const ch=line[i];
          if(inQ){
            if(ch==='"' && line[i+1]==='"'){ cur+='"'; i++; }
            else if(ch==='"'){ inQ=false; }
            else { cur+=ch; }
          }else{
            if(ch===','){ cells.push(cur.trim()); cur=''; }
            else if(ch==='"'){ inQ=true; }
            else { cur+=ch; }
          }
        }
        cells.push(cur.trim());
        return cells;
      }
      const headers = parseLine(lines[0]).map(h=>h.trim());
      return lines.slice(1).map(line=>{
        const cells = parseLine(line);
        const obj={}; headers.forEach((h,i)=>{ obj[h]=cells[i]?cells[i].trim():''; });
        return obj;
      });
    }

    function expandAgeTokens(tokens){
      const out=[]; const seen=new Set();
      tokens.forEach(t=>{
        const mapped = AGE_ALIASES[t] || [t];
        mapped.forEach(x=>{ if(!seen.has(x)){ seen.add(x); out.push(x); } });
      });
      return out;
    }

    function ageTokenSim(a,b){
      if(a===b) return 1;
      const ia = AGE_INDEX.has(a)?AGE_INDEX.get(a):null;
      const ib = AGE_INDEX.has(b)?AGE_INDEX.get(b):null;
      if(ia==null||ib==null) return 0;
      const d=Math.abs(ia-ib);
      if(d===1) return 0.75;
      if(d===2) return 0.55;
      return 0.25;
    }

    function relScore(domain,a,b){
      a=normalizeToken(a); b=normalizeToken(b);
      if(!a||!b) return 0;
      if(a===b) return 1;
      const m=RELATEDNESS[domain]||{};
      if(m[a]&&m[a][b]!=null) return m[a][b];
      if(m[b]&&m[b][a]!=null) return m[b][a];
      if(domain==='age' && (a==='all ages'||b==='all ages')) return 0.5;
      return 0;
    }

    function jaccard(aSet,bSet){
      if(aSet.length===0 && bSet.length===0) return 1;
      const A=new Set(aSet), B=new Set(bSet);
      let inter=0; A.forEach(x=>{ if(B.has(x)) inter++; });
      const uni=new Set([...A,...B]).size;
      return uni? inter/uni : 0;
    }

    function setRelatedness(domain,aSet,bSet){
      if(aSet.length===0 && bSet.length===0) return 1;
      function bestSum(X,Y){
        if(X.length===0||Y.length===0) return 0;
        let sum=0; X.forEach(x=>{
          let best=0; Y.forEach(y=>{ best=Math.max(best, relScore(domain,x,y)); });
          sum+=best;
        });
        return sum/ X.length;
      }
      const ab=bestSum(aSet,bSet), ba=bestSum(bSet,aSet);
      return (ab+ba)/2;
    }

    function ageSimilarity(aSet,bSet){
      const g=expandAgeTokens(aSet), t=expandAgeTokens(bSet);
      if(g.length===0 && t.length===0) return 1;
      if(g.length===0 || t.length===0) return 0;
      function avgBest(X,Y){
        let s=0;
        X.forEach(x=>{
          let best=0;
          Y.forEach(y=>{ best=Math.max(best, ageTokenSim(x,y)); });
          s+=best;
        });
        return s/X.length;
      }
      return (avgBest(g,t)+avgBest(t,g))/2;
    }

    function systemSimilarity(a,b){ if(!a&&!b) return 1; if(!a||!b) return 0; if(a===b) return 1; return relScore('system',a,b); }
    function etiologySimilarity(aSet,bSet){ return Math.max(jaccard(aSet,bSet), setRelatedness('etiology',aSet,bSet)); }
    function managementSimilarity(aSet,bSet){ return Math.max(jaccard(aSet,bSet), setRelatedness('management',aSet,bSet)); }
    function courseSimilarity(a,b){ if(!a&&!b) return 1; if(!a||!b) return 0; if(a===b) return 1; return relScore('course',a,b); }

    function clsForScore(score){
      if(score >= 0.85) return 'green';
      if(score >= 0.70) return 'amber';
      if(score >= 0.50) return 'orange';
      return 'red';
    }

    function maxSimAgainst(token, targetTokens, domain){
      if(domain==='age'){
        const g = expandAgeTokens([token]);
        const t = expandAgeTokens(targetTokens);
        let best=0;
        g.forEach(ga=>{
          t.forEach(tb=>{ best=Math.max(best, ageTokenSim(ga,tb)); });
        });
        return best;
      }
      let best=0;
      targetTokens.forEach(tb=>{
        if(token===tb) best=Math.max(best,1);
        else{
          const m=RELATEDNESS[domain]||{};
          if(m[token]&&m[token][tb]!=null) best=Math.max(best,m[token][tb]);
          if(m[tb]&&m[tb][token]!=null) best=Math.max(best,m[tb][token]);
        }
      });
      return best;
    }

    function displayAgeToken(tok){
      const norm = normalizeToken(tok);
      if(AGE_DISPLAY[norm]) return AGE_DISPLAY[norm];
      return title(tok);
    }

    function renderTokenChips(domain, guessTokens, targetTokens){
      const g = (domain==='age') ? expandAgeTokens(guessTokens) : guessTokens;
      const t = (domain==='age') ? expandAgeTokens(targetTokens) : targetTokens;
      const parts=[];
      g.forEach(tok=>{
        const s = maxSimAgainst(tok, t, domain);
        const cls = clsForScore(s);
        const label = (domain === 'age') ? displayAgeToken(tok) : title(tok);
        parts.push(`<span class="chip ${cls}" title="Similarity: ${(s*100).toFixed(0)}%"> ${escapeHtml(label)}</span>`);
      });
      if(parts.length===0) return '<span class="muted">â€”</span>';
      return parts.join(' ');
    }

    function normalizeRow(r){
      return {
        diagnosis: normalizeToken(r.Diagnosis||r.diagnosis),
        aliases: splitTags(r.Aliases||r.aliases),
        system: normalizeToken(r.System||r.system),
        age: splitTags(r.AgeGroup||r.agegroup||r.age),
        epidemiology: splitTags(r.Epidemiology||r.epidemiology),
        etiology: splitTags(r.Etiology||r.etiology),
        findings: splitTags(r.KeyFindings||r.keyfindings||r.findings),
        management: splitTags(r.Management||r.management),
        course: normalizeToken(r.Onset||r.onset||r.TypicalCourse||r.course||r.typicalcourse)
      };
    }

    function loadDataset(rows){
      DATA = rows.map(normalizeRow).filter(r=>r.diagnosis);
      BY_NAME = new Map();
      DATA.forEach(r=>{
        BY_NAME.set(r.diagnosis, r);
        r.aliases.forEach(a=>BY_NAME.set(a, r));
      });
      const dl=document.getElementById('diagnosisList');
      dl.innerHTML = DATA.map(r=>`<option value="${escapeHtml(title(r.diagnosis))}"></option>`).join('') +
                     DATA.flatMap(r=>r.aliases.map(a=>`<option value="${escapeHtml(title(a))}"></option>`)).join('');
    }

    function title(s){ return (s||'').split(' ').map(w=> w? (w[0].toUpperCase()+w.slice(1)) : '').join(' '); }

    function escapeHtml(str){
      return (str||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    }

    function showStatus(msg){
      const el = document.getElementById('statusMsg');
      if(!el) return;
      if(msg){
        el.textContent = msg;
        el.classList.add('status-visible');
      }else{
        el.textContent = '';
        el.classList.remove('status-visible');
      }
    }

    function updateProgress(score){
      const bar = document.getElementById('progressInner');
      if(!bar) return;
      const pct = Math.round(score*100);
      bar.style.width = pct + '%';
      bar.setAttribute('aria-valuenow', String(pct));
    }

    function displayVignette(dx){
      const vDiv = document.getElementById('vignetteText');
      if(!vDiv) return;
      const vign = VIGNETTES[dx.diagnosis] || 'A patient presents with a vague complaint.';
      vDiv.textContent = vign;
    }

    function getTodayStr(){
      return new Date().toISOString().slice(0,10);
    }

    function simpleHash(str){
      let h = 0;
      for(let i=0;i<str.length;i++){
        const ch = str.charCodeAt(i);
        h = ((h << 5) - h) + ch;
        h |= 0;
      }
      return h >>> 0;
    }

    function pickDailyTarget(){
      if(DATA.length===0) return;
      const dateKey = getTodayStr();
      const hash = simpleHash(dateKey);
      const idx = hash % DATA.length;
      TARGET = DATA[idx];
      displayVignette(TARGET);
    }

    function resetGame(){
      GUESSED = new Set();
      const tbody = document.querySelector('#table tbody');
      if(tbody) tbody.innerHTML='';
      const cards = document.getElementById('cardsContainer');
      if(cards) cards.innerHTML='';
      const guessInput = document.getElementById('guess');
      const guessBtn = document.getElementById('guessBtn');
      if(guessInput) guessInput.value='';
      if(guessInput) guessInput.disabled = false;
      if(guessBtn) guessBtn.disabled = false;
      guessesToday = 0;
      bestScoreSoFar = 0;
      solvedToday = false;
      updateProgress(0);
      showStatus('');
    }

    function startDailyGame(){
      pickDailyTarget();
      resetGame();
    }

    function avgWeighted(scores){
      const [scoreSystem,scoreAge,scoreEpi,scoreEti,scoreFind,scoreMgmt,scoreCourse] = scores;
      const num =
        scoreSystem * WEIGHTS.system +
        scoreAge    * WEIGHTS.age +
        scoreEpi    * WEIGHTS.epi +
        scoreEti    * WEIGHTS.etiology +
        scoreFind   * WEIGHTS.findings +
        scoreMgmt   * WEIGHTS.management +
        scoreCourse * WEIGHTS.course;
      return num / TOTAL_WEIGHT;
    }

    function renderRow(guess){
      const t=TARGET;
      const scoreSystem = systemSimilarity(guess.system, t.system);
      const scoreAge = ageSimilarity(guess.age, t.age);
      const scoreEpi = jaccard(guess.epidemiology, t.epidemiology);
      const scoreEti = etiologySimilarity(guess.etiology, t.etiology);
      const scoreFind = jaccard(guess.findings, t.findings);
      const scoreMgmt = managementSimilarity(guess.management, t.management);
      const scoreCourse = courseSimilarity(guess.course, t.course);

      const scoresArr = [scoreSystem,scoreAge,scoreEpi,scoreEti,scoreFind,scoreMgmt,scoreCourse];
      const mean = avgWeighted(scoresArr);

      if(mean > bestScoreSoFar){
        bestScoreSoFar = mean;
        updateProgress(bestScoreSoFar);
      }

      // Table row (desktop)
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${escapeHtml(title(guess.diagnosis))}</strong></td>
        <td>${renderTokenChips('system', [guess.system].filter(Boolean), [t.system].filter(Boolean))}</td>
        <td>${renderTokenChips('age', guess.age, t.age)}</td>
        <td>${renderTokenChips('epidemiology', guess.epidemiology, t.epidemiology)}</td>
        <td>${renderTokenChips('etiology', guess.etiology, t.etiology)}</td>
        <td>${renderTokenChips('findings', guess.findings, t.findings)}</td>
        <td>${renderTokenChips('management', guess.management, t.management)}</td>
        <td>${renderTokenChips('course', [guess.course].filter(Boolean), [t.course].filter(Boolean))}</td>`;
      document.querySelector('#table tbody').appendChild(tr);

      // Card view (mobile) â€“ prepend so last guess is shown first
      const cards = document.getElementById('cardsContainer');
      if(cards){
        const card = document.createElement('div');
        card.className = 'guess-card latest-card';
        card.innerHTML = `
          <div class="guess-card-header">${escapeHtml(title(guess.diagnosis))}</div>
          <div class="guess-card-row">
            <div class="guess-card-label">System</div>
            <div class="guess-card-value">${renderTokenChips('system', [guess.system].filter(Boolean), [t.system].filter(Boolean))}</div>
          </div>
          <div class="guess-card-row">
            <div class="guess-card-label">Age group</div>
            <div class="guess-card-value">${renderTokenChips('age', guess.age, t.age)}</div>
          </div>
          <div class="guess-card-row">
            <div class="guess-card-label">Epidemiology</div>
            <div class="guess-card-value">${renderTokenChips('epidemiology', guess.epidemiology, t.epidemiology)}</div>
          </div>
          <div class="guess-card-row">
            <div class="guess-card-label">Etiology</div>
            <div class="guess-card-value">${renderTokenChips('etiology', guess.etiology, t.etiology)}</div>
          </div>
          <div class="guess-card-row">
            <div class="guess-card-label">Findings</div>
            <div class="guess-card-value">${renderTokenChips('findings', guess.findings, t.findings)}</div>
          </div>
          <div class="guess-card-row">
            <div class="guess-card-label">Management</div>
            <div class="guess-card-value">${renderTokenChips('management', guess.management, t.management)}</div>
          </div>
          <div class="guess-card-row">
            <div class="guess-card-label">Course</div>
            <div class="guess-card-value">${renderTokenChips('course', [guess.course].filter(Boolean), [t.course].filter(Boolean))}</div>
          </div>`;
        if(cards.firstChild){
          cards.firstChild.classList.remove('latest-card');
          cards.insertBefore(card, cards.firstChild);
        }else{
          cards.appendChild(card);
        }
      }

      const solved = scoresArr.every(s=>s>=0.8);
      if(solved){
        handleSolved();
      }
    }

    function handleSolved(){
      solvedToday = true;
      const guessInput = document.getElementById('guess');
      const guessBtn = document.getElementById('guessBtn');
      if(guessInput) guessInput.disabled = true;
      if(guessBtn) guessBtn.disabled = true;

      const overlay = document.getElementById('solvedOverlay');
      const textEl = document.getElementById('solvedText');
      const dxEl = document.getElementById('solvedDx');
      if(textEl){
        textEl.textContent = `You solved today's case in ${guessesToday} attempts.`;
      }
      if(dxEl && TARGET){
        dxEl.textContent = `Diagnosis: ${title(TARGET.diagnosis)}`;
      }
      if(overlay){
        overlay.classList.add('is-open');
      }
      showStatus('');
    }

    function addGuess(input){
      if(!TARGET){
        showStatus('No active case. Please reload the page.');
        return;
      }
      if(solvedToday){
        showStatus('You already solved today\'s case. Come back tomorrow for a new one.');
        return;
      }
      let key = normalizeToken(input);
      if(!key){
        return;
      }
      const row = BY_NAME.get(key);
      if(!row){
        showStatus('Diagnosis not found in dataset. Try another term.');
        return;
      }
      const canonical = row.diagnosis;
      if(GUESSED.has(canonical)){
        showStatus('You already tried that diagnosis. Choose another one.');
        return;
      }
      GUESSED.add(canonical);
      guessesToday++;
      showStatus('');
      renderRow(row);
    }

    const guessInput=document.getElementById('guess');
    const guessBtn=document.getElementById('guessBtn');

    function submitGuess(){
      addGuess(guessInput.value);
      guessInput.value='';
      guessInput.focus();
    }

    guessBtn.addEventListener('click', submitGuess);
    guessInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); submitGuess(); }});

    const overlay = document.getElementById('solvedOverlay');
    const closeBtn = document.getElementById('closeSolvedBtn');
    const shareBtn = document.getElementById('shareBtn');

    if(closeBtn){
      closeBtn.addEventListener('click', ()=>{ overlay.classList.remove('is-open'); });
    }
    if(overlay){
      overlay.addEventListener('click', e=>{
        if(e.target === overlay){
          overlay.classList.remove('is-open');
        }
      });
    }
    if(shareBtn){
      shareBtn.addEventListener('click', async ()=>{
        if(!TARGET) return;
        const dxName = title(TARGET.diagnosis);
        const text = `Guess the Diagnosis: I solved today's case (${dxName}) in ${guessesToday} attempts!`;
        try{
          if(navigator.share){
            await navigator.share({ text });
          }else if(navigator.clipboard){
            await navigator.clipboard.writeText(text);
            shareBtn.textContent = 'Copied!';
            setTimeout(()=>{ shareBtn.textContent = 'Share'; }, 1500);
          }else{
            showStatus('Sharing not supported in this browser.');
          }
        }catch(e){
          // user cancelled share; ignore
        }
      });
    }

    const rows = parseCSV(CSV_30);
    loadDataset(rows);
    startDailyGame();
  })();
  </script>
</body>
</html>
